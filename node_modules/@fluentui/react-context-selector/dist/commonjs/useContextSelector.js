"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var React = _interopRequireWildcard(require("react"));

var _utils = require("./utils");

/**
 * This hook returns context selected value by selector.
 * It will only accept context created by `createContext`.
 * It will trigger re-render if only the selected value is referencially changed.
 */
var useContextSelector = function useContextSelector(context, selector) {
  var _React$useContext = React.useContext(context),
      subscribe = _React$useContext.subscribe,
      value = _React$useContext.value;

  var _ref = React.useReducer(function (c) {
    return c + 1;
  }, 0),
      _ref2 = (0, _slicedToArray2.default)(_ref, 2),
      forceUpdate = _ref2[1];

  var ref = React.useRef();
  var selected = selector(value);
  (0, _utils.useIsomorphicLayoutEffect)(function () {
    ref.current = {
      selector: selector,
      value: value,
      selected: selected
    };
  });
  (0, _utils.useIsomorphicLayoutEffect)(function () {
    var callback = function callback(nextState) {
      try {
        var reference = ref.current;

        if (reference.value === nextState || Object.is(reference.selected, reference.selector(nextState))) {
          // not changed
          return;
        }
      } catch (e) {// ignored (stale props or some other reason)
      }

      forceUpdate();
    };

    return subscribe(callback);
  }, [subscribe]);
  return selected;
};

var _default = useContextSelector;
exports.default = _default;
//# sourceMappingURL=useContextSelector.js.map
